<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Sistema de Gestión Integral Fiscal y Control Interno v5.0">
    <title>GINFI5.1 - Gestión Integral Fiscal</title>

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { darkbg: '#0f172a', darkcard: '#1e293b' },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('SW registrado: ', registration.scope))
                    .catch(err => console.log('SW error: ', err));
            });
        }
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, FileText, TrendingUp, Calendar, Trash2, Save, User, 
            Calculator, Download, X, Sparkles, Loader2, CheckCircle2, ChevronRight, 
            Building2, ShoppingCart, Receipt, ArrowDownCircle, ArrowUpCircle, 
            Wallet, Bell, Clock, Database, Upload, AlertCircle, Lock, LogOut, KeyRound, 
            Settings, ShieldCheck, Store, CreditCard, MessageSquare, Edit3, Eye, Truck,
            Users, AlertTriangle, FileSpreadsheet, CheckCircle, FileSearch
        } from 'lucide-react';

        // --- CATALOGOS Y DATOS ---
        const SAT_CATALOG = [
            { key: '43212100', label: 'Impresoras de computador', type: 'producto', unit: 'H87' },
            { key: '81112200', label: 'Servicio: Configuración Software', type: 'servicio', unit: 'E48' },
            { key: '43231500', label: 'Producto: Licencias (Office/Antivirus)', type: 'producto', unit: 'E48' },
            { key: '82101603', label: 'Servicio: Renta Computadoras', type: 'servicio', unit: 'E48' },
            { key: '82121500', label: 'Servicio: Impresiones', type: 'servicio', unit: 'H87' },
            { key: '43211503', label: 'Producto: Hardware (USB, Cables)', type: 'producto', unit: 'H87' },
            { key: '01010101', label: 'Genérico: Público General', type: 'servicio', unit: 'ACT' },
        ];
        
        const EXPENSE_CATEGORIES = [
            { id: 'mercancia', label: 'Compra de Mercancía' },
            { id: 'servicios', label: 'Servicios (Luz, Internet)' },
            { id: 'renta', label: 'Renta de Local' },
            { id: 'papeleria', label: 'Papelería y Consumibles' },
            { id: 'mantenimiento', label: 'Mantenimiento' },
            { id: 'otros', label: 'Otros Gastos' },
        ];

        const USOS_CFDI = [
            { code: 'G03', label: 'G03 - Gastos en general' },
            { code: 'G01', label: 'G01 - Adquisición de mercancías' },
            { code: 'I04', label: 'I04 - Equipo de cómputo y accesorios' },
            { code: 'D02', label: 'D02 - Gastos médicos' },
            { code: 'P01', label: 'P01 - Por definir' },
            { code: 'S01', label: 'S01 - Sin efectos fiscales' },
        ];
        
        const SALES_CHANNELS = ['Tienda Física', 'Venta en línea', 'Redes Sociales', 'Marketplace', 'Teléfono/WhatsApp', 'Otro'];
        const PAYMENT_METHODS = ['Efectivo', 'Tarjeta de Crédito', 'Tarjeta de Débito', 'Transferencia', 'Cheque', 'Por Definir'];

        // --- UTILS ---
        const getLocalDateString = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month =String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        const roundPrice = (num) => Math.round((num + Number.EPSILON) * 100) / 100;
        const normalizeText = (text) => {
            if (typeof text !== 'string') return text;
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/,/g, " ");
        };
        
        const isValidRFC = (rfc) => {
            if (!rfc) return true;
            const regex = /^([A-ZÑ&]{3,4}) ?(?:- ?)?(\d{2}(?:0[1-9]|1[0-2])(?:0[1-9]|[12]\d|3[01])) ?(?:- ?)?([A-Z\d]{2})([A-Z\d])$/;
            return regex.test(rfc.toUpperCase());
        };

        // --- STORAGE SERVICE ---
        const StorageService = {
            getData: (key) => { try { return JSON.parse(localStorage.getItem(key)) || []; } catch { return []; } },
            saveData: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            
            getSuppliers: () => StorageService.getData('gif4_suppliers'),
            saveSupplier: (supplier) => {
                let suppliers = StorageService.getSuppliers();
                const index = suppliers.findIndex(s => s.id === supplier.id || s.name === supplier.name);
                if (index >= 0) suppliers[index] = { ...suppliers[index], ...supplier }; else suppliers.push(supplier);
                StorageService.saveData('gif4_suppliers', suppliers);
                return suppliers;
            },
            deleteSupplier: (id) => {
                const s = StorageService.getSuppliers().filter(x => x.id !== id);
                StorageService.saveData('gif4_suppliers', s); return s;
            },
            deleteSale: (id) => {
                const s = StorageService.getData('gif4_sales').filter(x => x.id !== id);
                StorageService.saveData('gif4_sales', s); return s;
            },
            deleteExpense: (id) => {
                const e = StorageService.getData('gif4_expenses').filter(x => x.id !== id);
                StorageService.saveData('gif4_expenses', e); return e;
            }
        };

        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [loginPass, setLoginPass] = useState('');
            const [loginError, setLoginError] = useState('');
            const [view, setView] = useState('form');
            const [sales, setSales] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [suppliers, setSuppliers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isReadingPdf, setIsReadingPdf] = useState(false);
            
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);
            const [editingId, setEditingId] = useState(null); 
            const [detailsItem, setDetailsItem] = useState(null); 
            const [expenseTab, setExpenseTab] = useState('new'); 
            const [passData, setPassData] = useState({ current: '', new: '', confirm: '' });
            const [passMessage, setPassMessage] = useState({ text: '', type: '' });
            const [alertData, setAlertData] = useState(null);

            const [transactionDate, setTransactionDate] = useState(getLocalDateString());
            const [dateError, setDateError] = useState(false); 
            const [currentItems, setCurrentItems] = useState([]);
            const [newItem, setNewItem] = useState({ description: '', quantity: 1, unitPrice: 0, satKey: '82101603', unitKey: 'E48', type: 'servicio' });
            const [isInvoice, setIsInvoice] = useState(false);
            const [clientName, setClientName] = useState('Público en General');
            const [rfc, setRfc] = useState('');
            const [cp, setCp] = useState('');
            const [usoCfdi, setUsoCfdi] = useState('G03');
            const [salesChannel, setSalesChannel] = useState('Tienda Física');
            const [paymentMethod, setPaymentMethod] = useState('Efectivo');
            const [saleComments, setSaleComments] = useState('');
            const [folioInput, setFolioInput] = useState(''); 

            const [expenseData, setExpenseData] = useState({ providerName: '', rfcProvider: '', concept: '', subtotal: 0, iva: 0, total: 0, category: 'mercancia', uuid: '' });
            const [supplierForm, setSupplierForm] = useState({ id: null, name: '', rfc: '' });
            
            useEffect(() => {
                const session = sessionStorage.getItem('gif4_session');
                if (session === 'active') setIsAuthenticated(true);
                const legacySales = localStorage.getItem('ciber_sales');
                if(legacySales) { localStorage.setItem('gif4_sales', legacySales); localStorage.removeItem('ciber_sales'); }
                const legacyExpenses = localStorage.getItem('ciber_expenses');
                if(legacyExpenses) { localStorage.setItem('gif4_expenses', legacyExpenses); localStorage.removeItem('ciber_expenses'); }
                
                setSales(StorageService.getData('gif4_sales'));
                setExpenses(StorageService.getData('gif4_expenses'));
                setSuppliers(StorageService.getSuppliers());
                setLoading(false);
            }, []);

            useEffect(() => {
                const today = getLocalDateString();
                if (transactionDate > today) setDateError(true); else setDateError(false);
            }, [transactionDate]);

            useEffect(() => {
                if (currentItems.length > 0) {
                    const recalculatedItems = currentItems.map(item => calculateItemValues(item.unitPrice, item.quantity, isInvoice, item));
                    const oldTotal = currentItems.reduce((acc, i) => acc + i.total, 0);
                    const newTotal = recalculatedItems.reduce((acc, i) => acc + i.total, 0);
                    if (Math.abs(oldTotal - newTotal) > 0.01) setCurrentItems(recalculatedItems);
                }
            }, [isInvoice]);

            const isMoralClient = rfc.length === 12;
            const formatMoney = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const parts = dateString.split('-'); return `${parts[2]}/${parts[1]}/${parts[0]}`; 
            };
            
            const showAlert = (title, message, type = 'success') => {
                setAlertData({ title, message, type });
                setTimeout(() => setAlertData(null), 4000);
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const storedPass = localStorage.getItem('gif4_password') || 'admin';
                if (loginPass === storedPass) { sessionStorage.setItem('gif4_session', 'active'); setIsAuthenticated(true); setLoginError(''); } 
                else { setLoginError('Contraseña incorrecta'); setLoginPass(''); }
            };
            const handleLogout = () => { sessionStorage.removeItem('gif4_session'); setIsAuthenticated(false); setLoginPass(''); setView('form'); };
            
            // --- LOGICA DE LECTURA DE PDF (Inteligente por Contexto) ---
            const handlePdfUpload = async (e, context) => {
                const file = e.target.files[0];
                if (!file || file.type !== 'application/pdf') {
                    showAlert("Error", "Sube un archivo PDF válido.", "error");
                    return;
                }

                setIsReadingPdf(true);
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let fullText = '';

                    const page = await pdf.getPage(1);
                    const textContent = await page.getTextContent();
                    const items = textContent.items.map(item => item.str);
                    fullText = items.join(' ');

                    console.log(`Texto extraído (${context}):`, fullText);

                    if (context === 'expenses') {
                        // --- Lógica para GASTOS (Facturas SAT) ---
                        const uuidMatch = fullText.match(/[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}/);
                        const totalMatches = [...fullText.matchAll(/(?:Total|TOTAL|Neto)[:\s]*\$?\s*([\d,]+\.\d{2})/gi)];
                        let totalVal = 0;
                        if (totalMatches.length > 0) {
                            const lastMatch = totalMatches[totalMatches.length - 1][1];
                            totalVal = parseFloat(lastMatch.replace(/,/g, ''));
                        }
                        const ivaMatches = [...fullText.matchAll(/(?:IVA|Traslado|Impuesto)[:\s]*0?\.?160?0?%?[:\s]*\$?\s*([\d,]+\.\d{2})/gi)];
                        let ivaVal = 0;
                        if (ivaMatches.length > 0) {
                             const lastIva = ivaMatches[ivaMatches.length - 1][1];
                             ivaVal = parseFloat(lastIva.replace(/,/g, ''));
                        } else if (totalVal > 0) {
                            const simpleIva = fullText.match(/(?:IVA|I\.V\.A\.)[:\s]*\$?\s*([\d,]+\.\d{2})/i);
                            if(simpleIva) ivaVal = parseFloat(simpleIva[1].replace(/,/g, ''));
                        }

                        setExpenseData(prev => ({
                            ...prev,
                            uuid: uuidMatch ? uuidMatch[0].toUpperCase() : prev.uuid,
                            total: totalVal > 0 ? totalVal : prev.total,
                            iva: ivaVal > 0 ? ivaVal : (totalVal > 0 ? roundPrice(totalVal - (totalVal/1.16)) : 0),
                            subtotal: totalVal > 0 ? roundPrice(totalVal / 1.16) : prev.subtotal,
                            concept: "Compra según factura adjunta"
                        }));
                        showAlert("Factura Leída", `Datos: Total $${totalVal}, UUID detectado.`);

                    } else if (context === 'sales') {
                        // --- Lógica para VENTAS (Tickets CronoSys) ---
                        // 1. Buscar Folio (Formato usual en tickets: "Folio: 123", "Ticket #123")
                        const folioMatch = fullText.match(/(?:Folio|Ticket|Nota|Venta)[:\s]*#?(\d+)/i);
                        const folioFound = folioMatch ? folioMatch[1] : '';

                        // 2. Buscar Total (Generalmente al final del ticket)
                        const totalMatches = [...fullText.matchAll(/(?:Total|Pagar|Importe)[:\s]*\$?\s*([\d,]+\.\d{2})/gi)];
                        let totalVal = 0;
                        if (totalMatches.length > 0) {
                            // En tickets el total suele ser el último número grande asociado a "Total"
                            totalVal = parseFloat(totalMatches[totalMatches.length - 1][1].replace(/,/g, ''));
                        }

                        // 3. Rellenar campos para Agregar Item
                        if(folioFound) setFolioInput(folioFound); // Sugerir folio general
                        
                        setNewItem({
                            description: `Ticket ${folioFound ? '#' + folioFound : '(Ref. PDF)'}`,
                            quantity: 1,
                            unitPrice: totalVal > 0 ? totalVal : 0,
                            satKey: '01010101', // Público general por defecto para tickets
                            unitKey: 'ACT',
                            type: 'servicio'
                        });

                        showAlert("Ticket Leído", `Detectado: Folio ${folioFound || 'N/A'}, Total $${totalVal}`);
                    }

                } catch (error) {
                    console.error(error);
                    showAlert("Error Lectura", "No se pudo leer el PDF.", "error");
                } finally {
                    setIsReadingPdf(false);
                }
            };

            const handleChangePassword = (e) => {
                e.preventDefault();
                const storedPass = localStorage.getItem('gif4_password') || 'admin';
                if (passData.current !== storedPass) { setPassMessage({ text: 'Contraseña actual incorrecta.', type: 'error' }); return; }
                if (passData.new !== passData.confirm) { setPassMessage({ text: 'Las contraseñas no coinciden.', type: 'error' }); return; }
                localStorage.setItem('gif4_password', passData.new);
                setPassMessage({ text: 'Contraseña actualizada.', type: 'success' });
                setPassData({ current: '', new: '', confirm: '' });
                setTimeout(() => setPassMessage({ text: '', type: '' }), 3000);
            };

            const calculateItemValues = (inputPrice, qty, invoiceMode, existingItem = null) => {
                let subtotalLine = 0, ivaLine = 0, totalLine = 0;
                inputPrice = parseFloat(inputPrice) || 0;
                qty = parseInt(qty) || 1;
                if (invoiceMode) { subtotalLine = roundPrice(inputPrice * qty); ivaLine = roundPrice(subtotalLine * 0.16); totalLine = roundPrice(subtotalLine + ivaLine); } 
                else { totalLine = roundPrice(inputPrice * qty); subtotalLine = roundPrice(totalLine / 1.16); ivaLine = roundPrice(totalLine - subtotalLine); }
                return { 
                    id: existingItem?.id || generateId(), 
                    description: existingItem?.description || '', 
                    satKey: existingItem?.satKey || '01010101', 
                    unitKey: existingItem?.unitKey || 'E48',
                    type: existingItem?.type || 'servicio', 
                    quantity: qty, unitPrice: inputPrice, subtotal: subtotalLine, iva: ivaLine, total: totalLine 
                };
            };

            const addItem = () => {
                if (!newItem.description || !newItem.unitPrice) return;
                const item = calculateItemValues(parseFloat(newItem.unitPrice), parseInt(newItem.quantity) || 1, isInvoice, newItem);
                setCurrentItems([...currentItems, item]);
                setNewItem({ description: '', quantity: 1, unitPrice: 0, satKey: '82101603', unitKey: 'E48', type: 'servicio' }); 
            };

            const handleSaveSale = (e) => {
                e.preventDefault();
                if (currentItems.length === 0 || dateError) return;
                if (isInvoice && rfc.length < 12) { alert("Revise el RFC."); return; }
                const subtotalGlobal = roundPrice(currentItems.reduce((acc, item) => acc + item.subtotal, 0));
                const ivaGlobal = roundPrice(currentItems.reduce((acc, item) => acc + item.iva, 0));
                let retIsr = (isInvoice && isMoralClient) ? roundPrice(subtotalGlobal * 0.0125) : 0;
                const totalGlobal = roundPrice(subtotalGlobal + ivaGlobal - retIsr);
                let finalFolio;
                if (folioInput) { finalFolio = parseInt(folioInput); } 
                else if (editingId) { finalFolio = sales.find(s=>s.id===editingId).folio; } 
                else { finalFolio = (sales.length > 0 ? Math.max(...sales.map(s => s.folio || 0)) : 0) + 1; }

                const saleObj = {
                    id: editingId || generateId(), date: transactionDate, folio: finalFolio,
                    type: isInvoice ? 'factura' : 'publico_general', items: currentItems,
                    subtotal: subtotalGlobal, iva: ivaGlobal, retentionIsr: retIsr, total: totalGlobal,
                    clientName: clientName || 'Público en General', rfc: isInvoice ? rfc.toUpperCase() : 'XAXX010101000',
                    isMoral: isInvoice && isMoralClient, cp: isInvoice ? cp : '', usoCfdi: isInvoice ? usoCfdi : 'S01',
                    salesChannel, paymentMethod, saleComments
                };
                let updatedSales;
                if (editingId) { updatedSales = sales.map(s => s.id === editingId ? saleObj : s); StorageService.saveData('gif4_sales', updatedSales); showAlert('Venta Actualizada', 'Los datos se han guardado.'); } 
                else { updatedSales = [...sales, saleObj]; StorageService.saveData('gif4_sales', updatedSales); showAlert('Venta Registrada', 'Venta guardada exitosamente.'); }
                setSales(updatedSales); resetSaleForm(); setView('list');
            };

            const resetSaleForm = () => {
                setCurrentItems([]); setIsInvoice(false); setClientName('Público en General'); setRfc(''); setCp('');
                setSaleComments(''); setSalesChannel('Tienda Física'); setPaymentMethod('Efectivo');
                setEditingId(null); setTransactionDate(getLocalDateString()); setFolioInput(''); 
                setNewItem({ description: '', quantity: 1, unitPrice: 0, satKey: '82101603', unitKey: 'E48', type: 'servicio' });
            };

            const handleSaveExpense = (e) => {
                e.preventDefault();
                if (!expenseData.total || dateError) return;
                if (expenseData.providerName) {
                    const existingSupplier = suppliers.find(s => s.name === expenseData.providerName.toUpperCase());
                    if (!existingSupplier) {
                        const newSupplier = { id: generateId(), name: expenseData.providerName.toUpperCase(), rfc: expenseData.rfcProvider.toUpperCase() };
                        const updatedSuppliers = StorageService.saveSupplier(newSupplier);
                        setSuppliers(updatedSuppliers);
                    }
                }
                const totalExp = roundPrice(parseFloat(expenseData.total));
                const subtotalExp = roundPrice(expenseData.subtotal || (totalExp / 1.16));
                const ivaExp = roundPrice(expenseData.iva || (totalExp - subtotalExp));
                const expenseObj = {
                    id: editingId || generateId(), date: transactionDate, providerName: expenseData.providerName.toUpperCase(),
                    rfcProvider: expenseData.rfcProvider.toUpperCase(), concept: expenseData.concept, category: expenseData.category,
                    subtotal: subtotalExp, iva: ivaExp, total: totalExp, uuid: expenseData.uuid || ''
                };
                let updatedExpenses;
                if (editingId) { updatedExpenses = expenses.map(ex => ex.id === editingId ? expenseObj : ex); StorageService.saveData('gif4_expenses', updatedExpenses); showAlert('Gasto Actualizado', 'Modificaciones guardadas.'); } 
                else { updatedExpenses = [...expenses, expenseObj]; StorageService.saveData('gif4_expenses', updatedExpenses); showAlert('Gasto Registrado', 'Gasto guardado exitosamente.'); }
                setExpenses(updatedExpenses); resetExpenseForm(); setView('list');
            };

            const resetExpenseForm = () => {
                setExpenseData({ providerName: '', rfcProvider: '', concept: '', subtotal: 0, iva: 0, total: 0, category: 'mercancia', uuid: '' });
                setEditingId(null); setTransactionDate(getLocalDateString());
            };

            const handleSaveSupplier = (e) => {
                e.preventDefault();
                if (!supplierForm.name) return;
                const newSup = { id: supplierForm.id || generateId(), name: supplierForm.name.toUpperCase(), rfc: supplierForm.rfc.toUpperCase() };
                const updated = StorageService.saveSupplier(newSup); setSuppliers(updated);
                setSupplierForm({ id: null, name: '', rfc: '' }); showAlert('Proveedor Guardado', 'El catálogo ha sido actualizado.');
            };

            const handleEditSupplier = (sup) => { setSupplierForm({ id: sup.id, name: sup.name, rfc: sup.rfc }); };
            const handleDeleteSupplier = (id) => { 
                if(confirm('¿Eliminar proveedor?')){ 
                    const updated = StorageService.deleteSupplier(id); 
                    setSuppliers([...updated]); 
                    showAlert('Proveedor Eliminado', 'El registro ha sido borrado.', 'error');
                } 
            };
            const handleSelectProvider = (name) => {
                const sup = suppliers.find(s => s.name === name);
                if (sup) { setExpenseData(prev => ({ ...prev, providerName: sup.name, rfcProvider: sup.rfc })); } 
                else { setExpenseData(prev => ({ ...prev, providerName: name })); }
            };

            const handleEdit = (item, type) => {
                setEditingId(item.id); setTransactionDate(item.date);
                if (type === 'venta') {
                    setCurrentItems(item.items || []); setIsInvoice(item.type === 'factura'); setClientName(item.clientName);
                    setRfc(item.rfc === 'XAXX010101000' && !item.isInvoice ? '' : item.rfc); setCp(item.cp || ''); setUsoCfdi(item.usoCfdi || 'G03');
                    setSalesChannel(item.salesChannel || 'Tienda Física'); setPaymentMethod(item.paymentMethod || 'Efectivo'); setSaleComments(item.saleComments || '');
                    setFolioInput(item.folio.toString().padStart(3, '0')); 
                    setView('form');
                } else {
                    setExpenseData({ providerName: item.providerName, rfcProvider: item.rfcProvider, concept: item.concept, category: item.category, subtotal: item.subtotal, iva: item.iva, total: item.total, uuid: item.uuid });
                    setView('expenses'); setExpenseTab('new');
                }
            };

            const handleRequestDelete = (id) => { if (deleteConfirmId === id) { setDeleteConfirmId(null); } else { setDeleteConfirmId(id); setTimeout(() => setDeleteConfirmId(null), 3000); } };
            const handleConfirmDelete = (id, type) => { if (type === 'venta') { const newSales = StorageService.deleteSale(id); setSales(newSales); } else { const newExpenses = StorageService.deleteExpense(id); setExpenses(newExpenses); } setDeleteConfirmId(null); showAlert('Registro Eliminado', 'Se ha borrado el movimiento.', 'error'); };

            const handleExportData = () => {
                const data = { sales: StorageService.getData('gif4_sales'), expenses: StorageService.getData('gif4_expenses'), suppliers: StorageService.getSuppliers(), meta: { version: "4.0", timestamp: new Date().toISOString(), app: "GIF4.0" } };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `Respaldo_GIF5.0_${getLocalDateString()}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };
            const handleImportData = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.sales) { StorageService.saveData('gif4_sales', data.sales); setSales(data.sales); }
                        if (data.expenses) { StorageService.saveData('gif4_expenses', data.expenses); setExpenses(data.expenses); }
                        if (data.suppliers) { StorageService.saveData('gif4_suppliers', data.suppliers); setSuppliers(data.suppliers); }
                        showAlert('Importación Exitosa', `Se cargaron: ${data.sales?.length || 0} ventas, ${data.expenses?.length || 0} gastos, ${data.suppliers?.length || 0} proveedores.`);
                    } catch (error) { showAlert('Error Importación', 'Archivo inválido o corrupto.', 'error'); }
                };
                reader.readAsText(file);
            };

            const handleExportCSV = () => {
                const allSales = StorageService.getData('gif4_sales');
                const allExpenses = StorageService.getData('gif4_expenses');
                const csvRows = [];
                csvRows.push(['Tipo', 'Fecha', 'Folio/UUID', 'Cliente/Proveedor', 'RFC', 'Concepto', 'Subtotal', 'IVA', 'Total', 'Comentarios/Categoría']);
                allSales.forEach(s => {
                    const itemsDesc = s.items ? s.items.map(i => `${i.quantity}x ${i.description}`).join('; ') : '';
                    csvRows.push(['VENTA', s.date, s.folio, `"${normalizeText(s.clientName)}"`, s.rfc, `"${normalizeText(itemsDesc)}"`, s.subtotal, s.iva, s.total, `"${normalizeText(s.saleComments || '')}"`]);
                });
                allExpenses.forEach(e => {
                    csvRows.push(['GASTO', e.date, e.uuid || 'N/A', `"${normalizeText(e.providerName)}"`, e.rfcProvider, `"${normalizeText(e.concept)}"`, e.subtotal, e.iva, e.total, normalizeText(e.category)]);
                });
                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `Datos_GIF5.0_${getLocalDateString()}.csv`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };

            const handleImportCSV = (event) => {
                const file = event.target.files[0]; if (!file) return;
                if (!confirm('¡ATENCIÓN! La importación desde CSV agregará datos nuevos a los existentes. Asegúrate de que el formato sea correcto. ¿Continuar?')) { event.target.value = ''; return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result; const lines = content.split('\n');
                        if (lines.length < 2) throw new Error("Archivo vacío");
                        let sCount = 0; let eCount = 0;
                        const newSales = [...sales]; const newExpenses = [...expenses];
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim(); if (!line) continue;
                            const cols = line.split(',').map(c => c.replace(/^"|"$/g, ''));
                            if (cols.length < 9) continue;
                            const type = cols[0]; const date = cols[1];
                            if (type === 'VENTA') {
                                newSales.push({
                                    id: generateId(), date: date, folio: parseInt(cols[2]) || 0, type: 'publico_general', clientName: cols[3], rfc: cols[4], 
                                    items: [{ description: cols[5], quantity: 1, unitPrice: parseFloat(cols[8]), total: parseFloat(cols[8]) }], 
                                    subtotal: parseFloat(cols[6]), iva: parseFloat(cols[7]), total: parseFloat(cols[8]), saleComments: cols[9],
                                    salesChannel: 'Tienda Física', paymentMethod: 'Efectivo' 
                                }); sCount++;
                            } else if (type === 'GASTO') {
                                newExpenses.push({
                                    id: generateId(), date: date, uuid: cols[2] !== 'N/A' ? cols[2] : '', providerName: cols[3], rfcProvider: cols[4], 
                                    concept: cols[5], subtotal: parseFloat(cols[6]), iva: parseFloat(cols[7]), total: parseFloat(cols[8]), category: cols[9]
                                }); eCount++;
                            }
                        }
                        StorageService.saveData('gif4_sales', newSales); StorageService.saveData('gif4_expenses', newExpenses);
                        setSales(newSales); setExpenses(newExpenses);
                        showAlert('Importación CSV Exitosa', `Se agregaron: ${sCount} ventas y ${eCount} gastos.`);
                    } catch (error) { showAlert('Error CSV', 'Formato inválido.', 'error'); }
                };
                reader.readAsText(file);
            };

            const handleExportExcel = () => {
                const currentMonthStr = getLocalDateString().slice(0, 7);
                const mSales = sales.filter(s => s.date.startsWith(currentMonthStr));
                const mExpenses = expenses.filter(e => e.date.startsWith(currentMonthStr));
                
                let excelContent = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                    <head><meta charset="UTF-8"></head>
                    <body>
                        <h2>REPORTE MENSUAL DE OPERACIONES - GIF5.0</h2>
                        <h3>Periodo: ${currentMonthStr}</h3>
                        <br>
                        <h3>INGRESOS</h3>
                        <table border="1">
                            <thead>
                                <tr style="background-color: #d1fae5;"><th>Fecha</th><th>Folio</th><th>Cliente</th><th>RFC</th><th>Concepto</th><th>Base</th><th>IVA</th><th>Total</th></tr>
                            </thead>
                            <tbody>
                                ${mSales.map(s => `<tr>
                                    <td>${s.date}</td><td>${s.folio}</td><td>${s.clientName}</td><td>${s.rfc}</td>
                                    <td>${s.items.map(i=>i.description).join('; ')}</td>
                                    <td>${s.subtotal}</td><td>${s.iva}</td><td>${s.total}</td>
                                </tr>`).join('')}
                                <tr style="font-weight:bold;">
                                    <td colspan="5" align="right">TOTALES</td>
                                    <td>${roundPrice(mSales.reduce((a,b)=>a+b.subtotal,0))}</td>
                                    <td>${roundPrice(mSales.reduce((a,b)=>a+b.iva,0))}</td>
                                    <td>${roundPrice(mSales.reduce((a,b)=>a+b.total,0))}</td>
                                </tr>
                            </tbody>
                        </table>
                        <br>
                        <h3>GASTOS</h3>
                        <table border="1">
                            <thead>
                                <tr style="background-color: #ffe4e6;"><th>Fecha</th><th>UUID</th><th>Proveedor</th><th>RFC</th><th>Concepto</th><th>Base</th><th>IVA</th><th>Total</th></tr>
                            </thead>
                            <tbody>
                                ${mExpenses.map(e => `<tr>
                                    <td>${e.date}</td><td>${e.uuid}</td><td>${e.providerName}</td><td>${e.rfcProvider}</td>
                                    <td>${e.concept}</td>
                                    <td>${e.subtotal}</td><td>${e.iva}</td><td>${e.total}</td>
                                </tr>`).join('')}
                                <tr style="font-weight:bold;">
                                    <td colspan="5" align="right">TOTALES</td>
                                    <td>${roundPrice(mExpenses.reduce((a,b)=>a+b.subtotal,0))}</td>
                                    <td>${roundPrice(mExpenses.reduce((a,b)=>a+b.iva,0))}</td>
                                    <td>${roundPrice(mExpenses.reduce((a,b)=>a+b.total,0))}</td>
                                </tr>
                            </tbody>
                        </table>
                        <br>
                        <h3>AUDITORÍA DETALLADA (MOVIMIENTOS)</h3>
                        <table border="1">
                            <thead>
                                <tr style="background-color: #e0f2fe;"><th>Fecha</th><th>Tipo</th><th>Ref</th><th>Nombre</th><th>Concepto</th><th>Monto Total</th></tr>
                            </thead>
                            <tbody>
                                ${[...mSales.map(s => ({...s, kind: 'venta'})), ...mExpenses.map(e => ({...e, kind: 'gasto'}))]
                                    .sort((a,b)=> new Date(a.date).getTime() - new Date(b.date).getTime())
                                    .map(m => `<tr>
                                        <td>${m.date}</td>
                                        <td>${m.kind === 'venta' ? 'INGRESO' : 'EGRESO'}</td>
                                        <td>${m.kind === 'venta' ? m.folio : (m.uuid || 'N/A')}</td>
                                        <td>${m.kind === 'venta' ? m.clientName : m.providerName}</td>
                                        <td>${m.kind === 'venta' ? (m.items && m.items[0]?.description) : m.concept}</td>
                                        <td>${m.total}</td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </body>
                    </html>
                `;
                
                const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Reporte_Fiscal_${currentMonthStr}.xls`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const TaxReminder = () => {
                const today = new Date();
                const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                return (
                    <div className="bg-slate-900 dark:bg-slate-800 text-white p-3 rounded-2xl flex items-center justify-between shadow-lg shadow-slate-900/10 mb-6 no-print animate-fade-in transition-colors">
                        <div className="flex items-center gap-3"><div className="bg-indigo-600 p-2 rounded-xl"><Bell size={18} className="text-white" /></div><div><p className="text-xs text-slate-400 font-medium uppercase">Recordatorio Fiscal</p><p className="text-sm font-semibold">Declaración de {today.toLocaleString('es-MX', { month: 'long' })}: Límite 17 de {nextMonth.toLocaleString('es-MX', { month: 'long' })}</p></div></div>
                        <div className="bg-slate-800 px-3 py-1 rounded-lg text-xs font-mono text-indigo-300 border border-slate-700"><Clock size={12} className="inline mr-1"/> {getLocalDateString()}</div>
                    </div>
                );
            };

            const DateSelector = () => {
                return (
                    <div className={`mb-6 p-4 rounded-2xl border shadow-sm flex items-center gap-4 max-w-sm transition-colors ${dateError ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800' : 'bg-white dark:bg-slate-900 border-slate-100 dark:border-slate-800'}`}>
                        <div className={`p-2 rounded-xl ${dateError ? 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-200' : 'bg-indigo-50 text-indigo-600 dark:bg-slate-800 dark:text-indigo-400'}`}><Calendar size={20} /></div>
                        <div className="flex-1">
                            <label className={`block text-xs font-bold uppercase mb-1 ${dateError ? 'text-red-500' : 'text-slate-400'}`}>Fecha Registro {dateError && '(Futura - Inválida)'}</label>
                            <input type="date" value={transactionDate} onChange={(e) => setTransactionDate(e.target.value)} className={`w-full font-semibold outline-none bg-transparent dark:text-white ${dateError ? 'text-red-700 dark:text-red-400' : 'text-slate-700'}`}/>
                        </div>
                        {dateError && <div className="text-red-500 animate-pulse"><AlertTriangle size={20}/></div>}
                    </div>
                );
            };

            // Custom Alert Component
            const AlertModal = () => {
                if (!alertData) return null;
                return (
                    <div className="fixed top-24 right-4 z-[100] animate-fade-in pointer-events-none">
                         <div className={`flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl border pointer-events-auto ${alertData.type === 'error' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-white border-slate-200 text-slate-800'}`}>
                            {alertData.type === 'error' ? <AlertTriangle className="text-red-500"/> : <CheckCircle className="text-emerald-500"/>}
                            <div>
                                <h4 className="font-bold text-sm">{alertData.title}</h4>
                                <p className="text-xs opacity-90">{alertData.message}</p>
                            </div>
                        </div>
                    </div>
                );
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-100 dark:bg-slate-950"><Loader2 className="animate-spin text-slate-400" size={32} /></div>;
            if (!isAuthenticated) return (<div className="min-h-screen flex items-center justify-center bg-[#cbd5e1] p-6 animate-fade-in"><div className="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl shadow-2xl p-8 w-full max-w-sm border border-white dark:border-slate-800"><div className="text-center mb-8"><div className="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-500/30"><Lock size={32} className="text-white" /></div><h1 className="text-2xl font-bold text-slate-800 dark:text-white">GIF5.0 Acceso</h1><p className="text-slate-500 text-sm mt-1">Control Interno Seguro</p></div><form onSubmit={handleLogin} className="space-y-4"><div className="relative"><span className="absolute left-4 top-3.5 text-slate-400"><KeyRound size={20} /></span><input type="password" placeholder="Contraseña" value={loginPass} onChange={(e) => {setLoginPass(e.target.value); setLoginError('');}} className="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl py-3 pl-11 pr-4 text-slate-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all" autoFocus /></div>{loginError && <div className="text-red-500 text-sm text-center font-medium bg-red-50 p-2 rounded-lg">{loginError}</div>}<button type="submit" className="w-full bg-slate-900 hover:bg-black dark:bg-indigo-600 dark:hover:bg-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg transform active:scale-95 transition-all">Ingresar</button></form><p className="text-center text-xs text-slate-400 mt-6">Versión 5.0 Final</p></div></div>);

            const currentSubtotal = roundPrice(currentItems.reduce((a,b) => a + b.subtotal, 0));
            const currentIva = roundPrice(currentItems.reduce((a,b) => a + b.iva, 0));
            const currentRetIsr = (isInvoice && isMoralClient) ? roundPrice(currentSubtotal * 0.0125) : 0;
            const currentTotal = roundPrice(currentSubtotal + currentIva - currentRetIsr);

            return (
                <div className="min-h-screen text-slate-800 pb-24">
                    <AlertModal />
                    <div className="fixed top-0 left-0 right-0 z-50 flex justify-center pt-6 px-4 no-print pointer-events-none">
                        <nav className="pointer-events-auto glass rounded-full p-2 flex items-center gap-1 shadow-2xl shadow-black/5 dark:shadow-slate-900/50">
                            <button onClick={() => {setView('form'); resetSaleForm();}} className={`px-4 py-3 rounded-full flex items-center gap-2 transition-all ${view==='form'?'bg-slate-900 text-white shadow-lg dark:bg-indigo-600':'text-slate-500 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800'}`}><Plus size={18}/> <span className="hidden md:inline font-medium">Venta</span></button>
                            <button onClick={() => {setView('expenses'); resetExpenseForm(); setExpenseTab('new');}} className={`px-4 py-3 rounded-full flex items-center gap-2 transition-all ${view==='expenses'?'bg-rose-500 text-white shadow-lg':'text-slate-500 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800'}`}><ShoppingCart size={18}/> <span className="hidden md:inline font-medium">Gasto</span></button>
                            <button onClick={() => setView('list')} className={`px-4 py-3 rounded-full flex items-center gap-2 transition-all ${view==='list'?'bg-slate-900 text-white shadow-lg dark:bg-indigo-600':'text-slate-500 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800'}`}><FileText size={18}/> <span className="hidden md:inline font-medium">Historial</span></button>
                            <button onClick={() => setView('report')} className={`px-4 py-3 rounded-full flex items-center gap-2 transition-all ${view==='report'?'bg-slate-900 text-white shadow-lg dark:bg-indigo-600':'text-slate-500 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800'}`}><TrendingUp size={18}/> <span className="hidden md:inline font-medium">Reportes</span></button>
                            <button onClick={() => setView('settings')} className={`px-4 py-3 rounded-full flex items-center gap-2 transition-all ${view==='settings'?'bg-indigo-600 text-white shadow-lg':'text-slate-500 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800'}`}><Settings size={18}/></button>
                            <div className="w-px h-6 bg-slate-300 dark:bg-slate-700 mx-1"></div>
                            <button onClick={handleLogout} className="px-4 py-3 rounded-full flex items-center gap-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 transition-all"><LogOut size={18}/></button>
                        </nav>
                    </div>

                    <header className="max-w-4xl mx-auto pt-28 px-6 pb-2 flex justify-between items-end no-print">
                        <div><h1 className="text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight">GIF5.0</h1><p className="text-slate-500 dark:text-slate-400 font-medium mt-1">Gestión Integral Fiscal</p></div>
                        <div className="w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-800 border-2 border-white dark:border-slate-700 shadow-md overflow-hidden flex items-center justify-center"><User size={20} className="text-slate-500 dark:text-slate-300" /></div>
                    </header>
                    <div className="max-w-4xl mx-auto px-6"><TaxReminder /></div>

                    {view === 'form' && (
                        <main className="max-w-5xl mx-auto px-6 animate-fade-in">
                            <DateSelector />
                            {editingId && <div className="bg-amber-100 text-amber-800 p-4 rounded-2xl mb-6 flex items-center gap-2 font-bold shadow-sm border border-amber-200 dark:border-amber-800"><Edit3 size={20}/> Editando Venta Existente - Folio {sales.find(s=>s.id===editingId)?.folio}</div>}

                            <div className="bg-white rounded-3xl shadow-lg border border-slate-100 p-8">
                                <div className="flex items-center gap-3 mb-6"><div className="w-10 h-10 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-700"><Calculator size={20} /></div><h2 className="text-xl font-bold text-slate-800">Registrar Venta</h2></div>
                                
                                {/* --- SECCION IMPORTAR TICKET PDF (VENTA) --- */}
                                <div className="mb-6 p-4 border-2 border-dashed border-indigo-200 rounded-2xl bg-indigo-50/50 hover:bg-indigo-50 transition-colors flex items-center justify-center relative">
                                    <input 
                                        type="file" 
                                        accept="application/pdf" 
                                        onChange={(e) => handlePdfUpload(e, 'sales')} 
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                        disabled={isReadingPdf}
                                    />
                                    <div className="flex flex-col items-center gap-2 text-indigo-600">
                                        {isReadingPdf ? <Loader2 className="animate-spin" size={24}/> : <FileSearch size={24}/>}
                                        <span className="font-bold text-sm">{isReadingPdf ? 'Leyendo Ticket...' : 'Subir Ticket  (PDF)'}</span>
                                        {!isReadingPdf && <span className="text-xs text-indigo-400">Rellena Folio y Total para agregar rápido</span>}
                                    </div>
                                </div>
                                {/* --------------------------- */}

                                <div className="mb-6">
                                    <label className="flex items-center gap-3 p-4 rounded-2xl border border-slate-200 cursor-pointer hover:bg-slate-50 transition-colors">
                                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${isInvoice?'border-indigo-600 bg-indigo-600':'border-slate-300 dark:border-slate-600'}`}>{isInvoice && <CheckCircle2 size={14} className="text-white" />}</div>
                                        <input type="checkbox" checked={isInvoice} onChange={(e) => setIsInvoice(e.target.checked)} className="hidden" />
                                        <div className="flex-1"><span className="font-bold text-slate-700 dark:text-slate-200 block">¿Requiere Factura Fiscal?</span><span className="text-xs text-slate-500 dark:text-slate-400 block mt-0.5">{isInvoice ? "Precio BASE. Se sumará IVA." : "Precio NETO. Ya incluye IVA."}</span></div>
                                    </label>
                                </div>
                                <div className={`rounded-3xl p-8 mb-8 border transition-colors ${isInvoice?'bg-indigo-50/30 dark:bg-indigo-900/20 border-indigo-100 dark:border-indigo-800':'bg-slate-50/50 dark:bg-slate-800/50 border-slate-100/50 dark:border-slate-700'}`}>
                                    <div className="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
                                        <div className="col-span-1 md:col-span-2"><label className="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Cantidad</label><input type="number" min="1" value={newItem.quantity} onChange={(e) => setNewItem({...newItem, quantity: e.target.value})} className="neumorphic-input w-full rounded-xl px-4 py-3 text-center font-bold text-lg" /></div>
                                        <div className="col-span-1 md:col-span-10"><label className="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Concepto / Descripción</label><input type="text" placeholder="Ej. Tiempo Aire, Impresión..." value={newItem.description} onChange={(e) => setNewItem({...newItem, description: e.target.value})} className="neumorphic-input w-full rounded-xl px-4 py-3" /></div>
                                        <div className="col-span-1 md:col-span-6"><label className="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Clave SAT</label><select value={newItem.satKey} onChange={(e) => { const item = SAT_CATALOG.find(i => i.key === e.target.value); if(item) setNewItem({...newItem, satKey: item.key, type: item.type}); }} className="neumorphic-input w-full rounded-xl px-4 py-3 text-sm">{SAT_CATALOG.map(i => <option key={i.key} value={i.key}>{i.label}</option>)}</select></div>
                                        <div className="col-span-1 md:col-span-4"><label className="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">{isInvoice ? "Precio Base" : "Precio Neto"}</label><div className="relative"><span className="absolute left-3 top-3 text-slate-400">$</span><input type="number" placeholder="0.00" value={newItem.unitPrice || ''} onChange={(e) => setNewItem({...newItem, unitPrice: parseFloat(e.target.value)})} className="neumorphic-input w-full rounded-xl pl-7 pr-3 py-3 text-right font-medium" /></div></div>
                                        <div className="col-span-1 md:col-span-2"><button onClick={addItem} className="bg-slate-900 hover:bg-black dark:bg-indigo-600 dark:hover:bg-indigo-700 text-white w-full h-[48px] rounded-xl flex items-center justify-center shadow-lg transition-transform active:scale-95"><Plus size={24} /></button></div>
                                    </div>
                                    {currentItems.length > 0 && (
                                        <div className="mt-8 space-y-3">
                                            {currentItems.map(item => (
                                                <div key={item.id} className="flex items-center justify-between bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                                    <div className="flex items-center gap-4">
                                                        <div className="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-sm font-bold text-slate-600 dark:text-slate-300">{item.quantity}</div>
                                                        <div>
                                                            <p className="font-medium text-slate-800 dark:text-white">{item.description}</p>
                                                            {isInvoice && (
                                                                <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 text-xs text-slate-400 font-mono mt-1">
                                                                    <span>SAT: {item.satKey}</span>
                                                                    <span className="hidden sm:inline">•</span>
                                                                    <span>Base: {formatMoney(item.subtotal)}</span>
                                                                    <span className="hidden sm:inline">•</span>
                                                                    <span>IVA: {formatMoney(item.iva)}</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-4"><span className="font-bold text-lg text-slate-800 dark:text-white">{formatMoney(item.total)}</span><button onClick={() => setCurrentItems(currentItems.filter(i => i.id !== item.id))} className="text-red-400 hover:text-red-600 transition-colors"><X size={20} /></button></div>
                                                </div>
                                            ))}
                                            <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center"><span className="text-xl font-bold text-slate-700 dark:text-slate-300">Total a Cobrar</span><span className="text-3xl font-extrabold text-indigo-600 dark:text-indigo-400">{formatMoney(currentTotal)}</span></div>
                                        </div>
                                    )}
                                </div>
                                <form onSubmit={handleSaveSale}>
                                    <div className="mb-8">
                                        <h3 className="text-sm font-bold text-slate-400 uppercase mb-4 tracking-wide border-b border-slate-100 dark:border-slate-800 pb-2">Información Complementaria</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 ml-1 flex items-center gap-1"><User size={12}/> Nombre de Cliente</label><input type="text" value={clientName} onChange={(e) => setClientName(e.target.value)} className="neumorphic-input w-full rounded-xl px-4 py-3 uppercase" placeholder="Público General" /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 ml-1 flex items-center gap-1"><Store size={12}/> Canal de Venta</label><select value={salesChannel} onChange={(e) => setSalesChannel(e.target.value)} className="neumorphic-input w-full rounded-xl px-4 py-3 bg-white dark:bg-slate-800">{SALES_CHANNELS.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                            <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 ml-1 flex items-center gap-1"><CreditCard size={12}/> Método de Pago</label><select value={paymentMethod} onChange={(e) => setPaymentMethod(e.target.value)} className="neumorphic-input w-full rounded-xl px-4 py-3 bg-white dark:bg-slate-800">{PAYMENT_METHODS.map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                                            <div className="md:col-span-3"><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 ml-1 flex items-center gap-1"><MessageSquare size={12}/> Comentarios Adicionales</label><textarea value={saleComments} onChange={(e) => setSaleComments(e.target.value)} placeholder="Notas..." className="neumorphic-input w-full rounded-xl px-4 py-3 h-20 resize-none" /></div>
                                            <div className="md:col-span-3"><label className="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1 flex items-center gap-1">Folio (Opcional)</label><input type="number" placeholder="Automático si se deja vacío" value={folioInput} onChange={(e) => setFolioInput(e.target.value)} className="neumorphic-input w-full rounded-xl px-4 py-3" /></div>
                                        </div>
                                    </div>
                                    {isInvoice && (
                                        <div className="bg-indigo-50/50 dark:bg-indigo-900/20 p-8 rounded-3xl border border-indigo-100 dark:border-indigo-800 mb-8 animate-fade-in">
                                            <div className="flex items-center gap-2 mb-4 text-indigo-800 dark:text-indigo-300 font-bold border-b border-indigo-100 dark:border-indigo-800 pb-2"><FileText size={18}/> <span>Datos Fiscales Obligatorios</span></div>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                <div className="md:col-span-1"><label className="block text-xs font-bold text-indigo-400 uppercase mb-2 ml-1">RFC Cliente</label><input type="text" placeholder="XAXX010101000" value={rfc} onChange={(e) => setRfc(e.target.value.toUpperCase().replace(/\s/g, ''))} maxLength={13} className={`neumorphic-input w-full rounded-xl px-4 py-3 uppercase font-mono ${rfc && !isValidRFC(rfc) ? 'error' : ''}`} required={isInvoice} /></div>
                                                <div className="md:col-span-1"><label className="block text-xs font-bold text-indigo-400 uppercase mb-2 ml-1">Código Postal</label><input type="text" placeholder="20000" value={cp} onChange={(e) => setCp(e.target.value)} className="neumorphic-input w-full rounded-xl px-4 py-3" required={isInvoice} /></div>
                                                <div className="md:col-span-1"><label className="block text-xs font-bold text-indigo-400 uppercase mb-2 ml-1">Uso de CFDI</label><select value={usoCfdi} onChange={(e) => setUsoCfdi(e.target.value)} className="neumorphic-input w-full rounded-xl px-4 py-3 text-sm bg-white dark:bg-slate-800">{USOS_CFDI.map(uso => <option key={uso.code} value={uso.code}>{uso.label}</option>)}</select></div>
                                            </div>
                                        </div>
                                    )}
                                    <button type="submit" disabled={currentItems.length === 0 || dateError} className="bg-slate-900 hover:bg-black dark:bg-indigo-600 dark:hover:bg-indigo-700 text-white w-full py-5 rounded-2xl shadow-xl font-bold text-lg flex justify-center items-center gap-3 disabled:opacity-50 transition-all active:scale-[0.99] disabled:cursor-not-allowed"><Save size={22} /> Confirmar Venta</button>
                                </form>
                            </div>
                        </main>
                    )}

                    {view === 'expenses' && (
                        <main className="max-w-2xl mx-auto px-6 animate-fade-in">
                            <DateSelector />
                            {editingId && <div className="bg-amber-100 text-amber-800 p-4 rounded-2xl mb-6 flex items-center gap-2 font-bold shadow-sm border border-amber-200 dark:border-amber-800"><Edit3 size={20}/> Editando Gasto Existente</div>}
                            
                            <div className="flex gap-4 mb-6">
                                <button onClick={() => setExpenseTab('new')} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-colors ${expenseTab === 'new' ? 'bg-rose-500 text-white shadow-md' : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>Registrar Gasto</button>
                                <button onClick={() => setExpenseTab('suppliers')} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-colors ${expenseTab === 'suppliers' ? 'bg-indigo-600 text-white shadow-md' : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>Catálogo de Proveedores</button>
                            </div>

                            {expenseTab === 'new' ? (
                                <div className="bg-white rounded-3xl shadow-lg border border-rose-100 p-8">
                                    <div className="flex items-center gap-3 mb-6"><div className="w-10 h-10 rounded-2xl bg-rose-50 dark:bg-rose-900/30 flex items-center justify-center text-rose-600 dark:text-rose-400"><Receipt size={20} /></div><h2 className="text-xl font-bold text-slate-800 dark:text-white">Registrar Gasto</h2></div>
                                    
                                    {/* --- SECCION IMPORTAR FACTURA PDF (GASTO) --- */}
                                    <div className="mb-6 p-4 border-2 border-dashed border-rose-200 rounded-2xl bg-rose-50/50 hover:bg-rose-50 transition-colors flex items-center justify-center relative">
                                        <input 
                                            type="file" 
                                            accept="application/pdf" 
                                            onChange={(e) => handlePdfUpload(e, 'expenses')} 
                                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                            disabled={isReadingPdf}
                                        />
                                        <div className="flex flex-col items-center gap-2 text-rose-600">
                                            {isReadingPdf ? <Loader2 className="animate-spin" size={24}/> : <FileSearch size={24}/>}
                                            <span className="font-bold text-sm">{isReadingPdf ? 'Leyendo Factura...' : 'Subir Factura (PDF) para Auto-llenado'}</span>
                                            {!isReadingPdf && <span className="text-xs text-rose-400">Detecta UUID, Total e IVA de Facturas Fiscales</span>}
                                        </div>
                                    </div>
                                    {/* --------------------------- */}

                                    <form onSubmit={handleSaveExpense} className="space-y-4">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="col-span-2">
                                                <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Proveedor</label>
                                                <input 
                                                    type="text" 
                                                    list="provider-list" 
                                                    placeholder="Nombre del Proveedor" 
                                                    value={expenseData.providerName} 
                                                    onChange={(e)=>handleSelectProvider(e.target.value.toUpperCase())} 
                                                    className="neumorphic-input w-full rounded-xl px-3 py-3" 
                                                    required 
                                                />
                                                <datalist id="provider-list">{suppliers.map((s, i) => <option key={i} value={s.name} />)}</datalist>
                                            </div>
                                            <input type="text" placeholder="RFC Proveedor" value={expenseData.rfcProvider} onChange={(e)=>setExpenseData({...expenseData, rfcProvider: e.target.value.toUpperCase()})} className="neumorphic-input w-full rounded-xl px-3 py-3 uppercase font-mono" required />
                                            <input type="text" placeholder="UUID Fiscal (Opcional)" value={expenseData.uuid} onChange={(e)=>setExpenseData({...expenseData, uuid: e.target.value})} className="neumorphic-input w-full rounded-xl px-3 py-3 font-mono text-xs" />
                                        </div>
                                        <div className="bg-rose-50 p-4 rounded-2xl border border-rose-100 dark:border-rose-900">
                                            <div className="grid grid-cols-2 gap-4">
                                                <select value={expenseData.category} onChange={(e)=>setExpenseData({...expenseData, category: e.target.value})} className="neumorphic-input w-full rounded-xl px-3 py-3 col-span-2 bg-white dark:bg-slate-800">{EXPENSE_CATEGORIES.map(cat => <option key={cat.id} value={cat.id}>{cat.label}</option>)}</select>
                                                <div className="col-span-2"><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Uso de CFDI (Gasto)</label><select value={expenseData.usoCfdi} onChange={(e)=>setExpenseData({...expenseData, usoCfdi: e.target.value})} className="neumorphic-input w-full rounded-xl px-3 py-3 col-span-2 bg-white">{USOS_CFDI.map(uso => <option key={uso.code} value={uso.code}>{uso.label}</option>)}</select></div>
                                                <input type="text" placeholder="Concepto" value={expenseData.concept} onChange={(e)=>setExpenseData({...expenseData, concept: e.target.value})} className="neumorphic-input w-full rounded-xl px-3 py-3 col-span-2 bg-white dark:bg-slate-800" required />
                                                <div className="col-span-2"><label className="text-xs text-slate-400 ml-1">Total Pagado (Neto)</label><input type="number" placeholder="$0.00" value={expenseData.total || ''} onChange={(e)=>setExpenseData({...expenseData, total: parseFloat(e.target.value)})} className="neumorphic-input w-full rounded-xl px-3 py-3 text-center text-lg font-bold bg-white dark:bg-slate-800" required /></div>
                                            </div>
                                        </div>
                                        <button type="submit" disabled={dateError} className="bg-rose-50 text-rose-600 hover:bg-rose-100 dark:bg-rose-900/40 dark:hover:bg-rose-900/60 text-rose-600 dark:text-rose-300 border border-rose-200 dark:border-rose-800 w-full py-4 rounded-2xl font-bold flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"><Save size={20} /> {editingId ? 'Actualizar Gasto' : 'Guardar Gasto'}</button>
                                    </form>
                                </div>
                            ) : (
                                <div className="bg-white rounded-3xl shadow-lg border border-indigo-100 p-8">
                                    <div className="flex items-center gap-3 mb-6"><div className="w-10 h-10 rounded-2xl bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400"><Users size={20} /></div><h2 className="text-xl font-bold text-slate-800 dark:text-white">Gestión de Proveedores</h2></div>
                                    <form onSubmit={handleSaveSupplier} className="mb-8 bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700">
                                        <h3 className="text-xs font-bold text-slate-400 uppercase mb-3">{supplierForm.id ? 'Editar Proveedor' : 'Nuevo Proveedor'}</h3>
                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                            <input type="text" placeholder="Nombre Comercial" value={supplierForm.name} onChange={(e) => setSupplierForm({...supplierForm, name: e.target.value.toUpperCase()})} className="neumorphic-input w-full rounded-xl px-3 py-2 uppercase" required />
                                            <input type="text" placeholder="RFC" value={supplierForm.rfc} onChange={(e) => setSupplierForm({...supplierForm, rfc: e.target.value.toUpperCase()})} className="neumorphic-input w-full rounded-xl px-3 py-2 uppercase font-mono" required />
                                        </div>
                                        <div className="flex justify-end gap-2">
                                            {supplierForm.id && <button type="button" onClick={() => setSupplierForm({ id: null, name: '', rfc: '' })} className="text-slate-400 hover:text-slate-600 text-sm">Cancelar</button>}
                                            <button type="submit" className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-indigo-700">{supplierForm.id ? 'Actualizar' : 'Guardar'}</button>
                                        </div>
                                    </form>
                                    <div className="space-y-2">
                                        {suppliers.map(s => (
                                            <div key={s.id} className="flex justify-between items-center p-3 bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-xl hover:shadow-sm transition-shadow">
                                                <div><p className="font-bold text-slate-700 dark:text-slate-200 text-sm">{s.name}</p><p className="text-xs text-slate-400 font-mono">{s.rfc}</p></div>
                                                <div className="flex gap-2"><button onClick={() => handleEditSupplier(s)} className="p-1.5 text-indigo-400 hover:bg-indigo-50 dark:hover:bg-slate-800 rounded-lg"><Edit3 size={16}/></button><button onClick={() => handleDeleteSupplier(s.id)} className="p-1.5 text-red-400 hover:bg-red-50 dark:hover:bg-slate-800 rounded-lg"><Trash2 size={16}/></button></div>
                                            </div>
                                        ))}
                                        {suppliers.length === 0 && <p className="text-center text-slate-400 italic text-sm py-4">No hay proveedores registrados.</p>}
                                    </div>
                                </div>
                            )}
                        </main>
                    )}

                    {view === 'list' && (
                        <main className="max-w-4xl mx-auto px-6 animate-fade-in">
                            <div className="bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden">
                                <div className="p-6 border-b border-slate-100 bg-slate-50/50"><h2 className="font-bold text-slate-700">Movimientos</h2></div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-50 text-slate-400 text-xs uppercase font-semibold text-left"><tr><th className="px-6 py-4">Tipo</th><th className="px-6 py-4">Folio</th><th className="px-6 py-4">Fecha</th><th className="px-6 py-4">Descripción</th><th className="px-6 py-4 text-right">Monto</th><th className="px-6 py-4 text-center">Acciones</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {[...sales.map(s=>({...s, kind:'venta'})), ...expenses.map(e=>({...e, kind:'gasto'}))].sort((a,b)=> new Date(b.date).getTime() - new Date(a.date).getTime()).map((item) => (
                                                <tr key={item.id} className="hover:bg-slate-50/50 transition-colors">
                                                    <td className="px-6 py-4">{item.kind==='venta' ? <span className="inline-flex items-center gap-1 text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg text-xs font-bold"><ArrowUpCircle size={12}/> VENTA</span> : <span className="inline-flex items-center gap-1 text-rose-600 bg-rose-50 px-2 py-1 rounded-lg text-xs font-bold"><ArrowDownCircle size={12}/> GASTO</span>}</td>
                                                    <td className="px-6 py-4 font-mono text-xs text-slate-500">{item.kind === 'venta' ? `#${String(item.folio).padStart(3, '0')}` : '-'}</td>
                                                    <td className="px-6 py-4 text-slate-400 font-mono text-xs">{formatDate(item.date)}</td>
                                                    <td className="px-6 py-4 text-slate-700">{item.kind==='venta' ? (item.clientName || 'Público General') : (item.providerName || 'Proveedor')}<span className="block text-xs text-slate-400">{item.kind==='venta' ? (item.items && item.items.length > 0 ? item.items[0].description : 'Venta') : item.category}</span></td>
                                                    <td className={`px-6 py-4 text-right font-bold ${item.kind==='venta'?'text-emerald-700':'text-rose-700'}`}>{item.kind==='gasto' && '- '}{formatMoney(item.total)}</td>
                                                    <td className="px-6 py-4 text-center flex items-center justify-center gap-2">
                                                        <button onClick={() => setDetailsItem(item)} className="bg-indigo-100 text-indigo-600 p-2 rounded-lg hover:bg-indigo-200 transition-colors" title="Ver Detalles"><Eye size={16}/></button>
                                                        <button onClick={() => handleEdit(item, item.kind)} className="bg-slate-100 text-slate-600 p-2 rounded-lg hover:bg-slate-200 transition-colors" title="Editar"><Edit3 size={16}/></button>
                                                        {deleteConfirmId === item.id ? (
                                                            <button onClick={() => handleConfirmDelete(item.id, item.kind)} className="bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-600 transition-colors">¿Borrar?</button>
                                                        ) : (
                                                            <button onClick={() => handleRequestDelete(item.id)} className="text-slate-300 hover:text-red-500 p-2 transition-colors"><Trash2 size={16}/></button>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </main>
                    )}

                    {view === 'settings' && (
                        <main className="max-w-2xl mx-auto px-6 animate-fade-in space-y-8">
                            <div className="bg-white rounded-3xl shadow-lg border border-slate-100 p-8">
                                <div className="flex items-center gap-3 mb-6"><div className="w-10 h-10 rounded-2xl bg-indigo-50 flex items-center justify-center text-indigo-600"><ShieldCheck size={20} /></div><h2 className="text-xl font-bold text-slate-800">Seguridad</h2></div>
                                <form onSubmit={handleChangePassword} className="space-y-4">
                                    <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Contraseña Actual</label><input type="password" value={passData.current} onChange={(e) => setPassData({...passData, current: e.target.value})} className="neumorphic-input w-full rounded-xl px-4 py-3" required /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Nueva Contraseña</label><input type="password" value={passData.new} onChange={(e) => setPassData({...passData, new: e.target.value})} className="neumorphic-input w-full rounded-xl px-4 py-3" required /></div>
                                        <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Confirmar Nueva</label><input type="password" value={passData.confirm} onChange={(e) => setPassData({...passData, confirm: e.target.value})} className="neumorphic-input w-full rounded-xl px-4 py-3" required /></div>
                                    </div>
                                    {passMessage.text && (<div className={`text-sm p-3 rounded-xl font-medium text-center ${passMessage.type === 'error' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>{passMessage.text}</div>)}
                                    <button type="submit" className="bg-slate-900 text-white w-full py-3 rounded-xl font-bold hover:bg-black transition-colors">Actualizar Contraseña</button>
                                </form>
                            </div>
                            <div className="bg-white rounded-3xl shadow-lg border border-slate-100 p-8">
                                <div className="flex items-center gap-3 mb-6"><div className="w-10 h-10 rounded-2xl bg-indigo-50 flex items-center justify-center text-indigo-600"><Database size={20} /></div><h2 className="text-xl font-bold text-slate-800">Respaldo de Datos</h2></div>
                                <div className="space-y-6">
                                    <div className="p-6 rounded-2xl border border-slate-200 hover:border-indigo-300 transition-colors cursor-pointer group" onClick={handleExportData}>
                                        <div className="flex items-center gap-4"><div className="p-3 bg-slate-100 rounded-full group-hover:bg-indigo-50 text-slate-600 group-hover:text-indigo-600 transition-colors"><Download size={24}/></div><div><h3 className="font-bold text-slate-800">Exportar Respaldo (JSON)</h3><p className="text-xs text-slate-400">Descargar copia completa.</p></div></div>
                                    </div>
                                    <div className="p-6 rounded-2xl border border-slate-200 hover:border-emerald-300 transition-colors cursor-pointer group" onClick={handleExportCSV}>
                                        <div className="flex items-center gap-4"><div className="p-3 bg-slate-100 rounded-full group-hover:bg-emerald-50 text-slate-600 group-hover:text-emerald-600 transition-colors"><FileSpreadsheet size={24}/></div><div><h3 className="font-bold text-slate-800">Exportar a CSV</h3><p className="text-xs text-slate-400">Para Excel o Hojas de Cálculo.</p></div></div>
                                    </div>
                                    <div className="p-6 rounded-2xl border border-slate-200 hover:border-emerald-300 transition-colors cursor-pointer group relative">
                                        <input type="file" accept=".json,.csv" onChange={(e) => e.target.files[0].name.endsWith('.csv') ? handleImportCSV(e) : handleImportData(e)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                        <div className="flex items-center gap-4"><div className="p-3 bg-slate-100 rounded-full group-hover:bg-emerald-50 text-slate-600 group-hover:text-emerald-600 transition-colors"><Upload size={24}/></div><div><h3 className="font-bold text-slate-800">Importar Datos (JSON/CSV)</h3><p className="text-xs text-slate-400">Restaurar respaldo o migrar.</p></div></div>
                                    </div>
                                </div>
                            </div>
                        </main>
                    )}

                    {view === 'report' && (
                        <main className="max-w-4xl mx-auto px-6 animate-fade-in space-y-6">
                            <div className="flex justify-end no-print">
                                <button onClick={handleExportExcel} className="bg-white text-emerald-600 border border-emerald-200 px-4 py-2 rounded-xl flex items-center gap-2 shadow-sm font-medium hover:bg-emerald-50 transition-colors"><FileSpreadsheet size={18} /> Exportar Reporte Mensual (Excel)</button>
                            </div>
                            <div id="report-content" className="bg-white rounded-3xl shadow-lg border border-slate-100 p-8">
                                <div className="flex justify-between items-start mb-4 border-b border-slate-100 pb-4"><div><h1 className="text-lg font-bold text-slate-900 mb-1 report-header">REPORTE DE OPERACIONES</h1><p className="text-slate-400 text-sm font-medium report-subheader">Resumen Mensual de Operaciones</p></div><div className="text-right"><p className="text-slate-800 font-semibold text-sm">{new Date().toLocaleString('es-MX', { month: 'long', year: 'numeric' }).toUpperCase()}</p></div></div>
                                {(() => {
                                    const currentMonthStr = getLocalDateString().slice(0, 7); 
                                    const mSales = sales.filter(s => s.date.startsWith(currentMonthStr));
                                    const mExpenses = expenses.filter(e => e.date.startsWith(currentMonthStr));
                                    const totalVentasNeto = roundPrice(mSales.reduce((a,b) => a + b.subtotal, 0));
                                    const totalIvaCobrado = roundPrice(mSales.reduce((a,b) => a + b.iva, 0));
                                    const totalRetenido = roundPrice(mSales.reduce((a,b) => a + (b.retentionIsr || 0), 0));
                                    const totalGastosNeto = roundPrice(mExpenses.reduce((a,b) => a + b.subtotal, 0));
                                    const totalIvaPagado = roundPrice(mExpenses.reduce((a,b) => a + b.iva, 0));
                                    const ivaPorPagar = roundPrice(totalIvaCobrado - totalIvaPagado);
                                    const utilidadOperativa = roundPrice(totalVentasNeto - totalGastosNeto);
                                    const reportMovements = [...mSales.map(s => ({...s, kind: 'venta'})), ...mExpenses.map(e => ({...e, kind: 'gasto'}))].sort((a,b)=> new Date(a.date).getTime() - new Date(b.date).getTime());

                                    return (
                                        <div className="space-y-6">
                                            <div className="grid grid-cols-3 gap-6">
                                                <div className="p-4 bg-slate-50 rounded-xl border border-slate-100"><p className="text-xs font-bold text-slate-400 uppercase mb-1 report-card-title">Ingresos (Sin IVA)</p><p className="text-xl font-bold text-emerald-600">{formatMoney(totalVentasNeto)}</p></div>
                                                <div className="p-4 bg-slate-50 rounded-xl border border-slate-100"><p className="text-xs font-bold text-slate-400 uppercase mb-1 report-card-title">Gastos (Deducibles)</p><p className="text-xl font-bold text-rose-600">{formatMoney(totalGastosNeto)}</p></div>
                                                <div className="p-4 bg-slate-900 text-white rounded-xl shadow-sm"><p className="text-xs font-bold text-slate-400 uppercase mb-1 report-card-title">Utilidad Bruta</p><p className="text-xl font-bold text-white">{formatMoney(utilidadOperativa)}</p></div>
                                            </div>
                                            <div className="bg-indigo-50/50 rounded-xl p-6 border border-indigo-100">
                                                <div className="flex justify-between items-center mb-4"><h3 className="text-sm font-bold text-slate-800 uppercase tracking-wide">Cálculo de IVA</h3></div>
                                                <div className="space-y-3 text-xs w-full">
                                                    <div className="flex justify-between items-center"><span className="text-slate-500">IVA Trasladado</span><span className="font-bold text-slate-700">{formatMoney(totalIvaCobrado)}</span></div>
                                                    <div className="flex justify-between items-center text-rose-600"><span className="flex items-center gap-2">IVA Acreditable</span><span className="font-bold">- {formatMoney(totalIvaPagado)}</span></div>
                                                    <div className="h-px bg-indigo-200 my-2"></div>
                                                    <div className="flex justify-between items-center text-sm"><span className="font-bold text-indigo-900">IVA A PAGAR</span><span className={`font-extrabold ${ivaPorPagar > 0 ? 'text-indigo-600' : 'text-emerald-500'}`}>{ivaPorPagar > 0 ? formatMoney(ivaPorPagar) : `Saldo a Favor ${formatMoney(Math.abs(ivaPorPagar))}`}</span></div>
                                                    {totalRetenido > 0 && <p className="text-[10px] text-center text-slate-400 mt-1">* ISR Retenido a favor: {formatMoney(totalRetenido)}</p>}
                                                </div>
                                            </div>
                                            
                                            <div className="pt-8 mt-4 border-t border-slate-200">
                                                <h4 className="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2 tracking-wide"><FileText size={12}/> Detalle de Movimientos (Auditoría)</h4>
                                                <table className="w-full text-[9px] text-left border-collapse">
                                                    <thead className="text-slate-500 bg-slate-50 uppercase font-medium border-b border-slate-200"><tr><th className="py-1 px-1">Fecha</th><th className="py-1 px-1">Tipo</th><th className="py-1 px-1">Folio/UUID</th><th className="py-1 px-1">RFC</th><th className="py-1 px-1">Concepto</th><th className="py-1 px-1 text-right">Subtotal</th><th className="py-1 px-1 text-right">IVA</th><th className="py-1 px-1 text-right">Total</th></tr></thead>
                                                    <tbody className="divide-y divide-slate-100">{reportMovements.map(m => (<tr key={m.id}><td className="py-1 px-1 text-slate-500">{formatDate(m.date)}</td><td className="py-1 px-1"><span className={`font-bold ${m.kind==='venta' ? 'text-emerald-600' : 'text-rose-600'}`}>{m.kind === 'venta' ? 'ING' : 'EGR'}</span></td><td className="py-1 px-1 font-mono text-slate-400 truncate max-w-[60px]">{m.kind==='venta'?`#${m.folio}`:m.uuid.slice(0,6)+'...'}</td><td className="py-1 px-1 font-mono text-[8px]">{m.kind==='venta'?m.rfc:m.rfcProvider}</td><td className="py-1 px-1 truncate max-w-[100px]">{m.kind==='venta'?(m.items && m.items.length > 0 ? m.items[0].description : 'Venta') : m.concept}</td><td className="py-1 px-1 text-right">{formatMoney(m.subtotal)}</td><td className="py-1 px-1 text-right">{formatMoney(m.iva)}</td><td className="py-1 px-1 text-right font-bold">{formatMoney(m.total)}</td></tr>))}</tbody>
                                                </table>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        </main>
                    )}

                    {detailsItem && (
                        <div className="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-[60] animate-fade-in">
                            <div className="bg-white rounded-3xl shadow-2xl max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto border border-slate-100">
                                <div className="flex justify-between items-start mb-6"><div><h2 className="text-2xl font-bold text-slate-900">Detalles</h2><p className="text-slate-500 text-sm mt-1">ID: <span className="font-mono">{detailsItem.id}</span></p></div><button onClick={() => setDetailsItem(null)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200"><X size={20}/></button></div>
                                <div className="grid grid-cols-2 gap-6 mb-6">
                                    <div className="bg-slate-50 p-4 rounded-2xl"><p className="text-xs text-slate-400 uppercase font-bold mb-1">Fecha</p><p className="text-lg font-medium">{formatDate(detailsItem.date)}</p></div>
                                    <div className="bg-slate-50 p-4 rounded-2xl"><p className="text-xs text-slate-400 uppercase font-bold mb-1">Tipo</p><p className={`text-lg font-bold ${detailsItem.kind === 'venta' ? 'text-emerald-600' : 'text-rose-600'}`}>{detailsItem.kind === 'venta' ? 'VENTA' : 'GASTO'}</p></div>
                                </div>
                                {detailsItem.kind === 'venta' ? (
                                    <div className="space-y-6">
                                         <div className="grid grid-cols-2 gap-4 text-sm">
                                            <div><span className="block text-slate-400 text-xs uppercase">Cliente</span><span className="font-medium">{detailsItem.clientName}</span></div>
                                            <div><span className="block text-slate-400 text-xs uppercase">Folio</span><span className="font-medium font-mono">#{String(detailsItem.folio).padStart(3, '0')}</span></div>
                                            <div><span className="block text-slate-400 text-xs uppercase">RFC</span><span className="font-medium font-mono">{detailsItem.rfc || 'N/A'}</span></div>
                                            <div><span className="block text-slate-400 text-xs uppercase">Método Pago</span><span className="font-medium">{detailsItem.paymentMethod}</span></div>
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-slate-700 mb-3 border-b pb-2">Artículos</h3>
                                            <table className="w-full text-sm"><thead className="text-xs text-slate-400 bg-slate-50 uppercase text-left"><tr><th className="p-2">Cant</th><th className="p-2">Concepto</th><th className="p-2 text-right">Total</th></tr></thead><tbody>{detailsItem.items.map((it, idx) => (
                                                <tr key={idx} className="border-b border-slate-50">
                                                    <td className="p-2 font-bold">{it.quantity}</td>
                                                    <td className="p-2">
                                                        {it.description}
                                                        <div className="flex flex-col sm:flex-row gap-1 sm:gap-2 text-xs text-slate-400 font-mono mt-1">
                                                            <span>SAT: {it.satKey}</span>
                                                            {detailsItem.type === 'factura' && (
                                                                <>
                                                                    <span className="hidden sm:inline">•</span><span>Base: {formatMoney(it.subtotal)}</span>
                                                                    <span className="hidden sm:inline">•</span><span>IVA: {formatMoney(it.iva)}</span>
                                                                </>
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="p-2 text-right">{formatMoney(it.total)}</td>
                                                </tr>
                                            ))}</tbody></table>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                            <div><span className="block text-slate-400 text-xs uppercase">Proveedor</span><span className="font-medium">{detailsItem.providerName}</span></div>
                                            <div><span className="block text-slate-400 text-xs uppercase">RFC Prov.</span><span className="font-medium font-mono">{detailsItem.rfcProvider}</span></div>
                                            <div><span className="block text-slate-400 text-xs uppercase">Categoría</span><span className="font-medium">{detailsItem.category}</span></div>
                                            <div><span className="block text-slate-400 text-xs uppercase">UUID</span><span className="font-medium font-mono text-xs">{detailsItem.uuid || 'N/A'}</span></div>
                                        </div>
                                        <div className="bg-slate-50 p-4 rounded-xl"><span className="block text-slate-400 text-xs uppercase mb-1">Concepto</span><p className="font-medium text-slate-800">{detailsItem.concept}</p></div>
                                    </div>
                                )}
                                <div className="mt-8 pt-6 border-t border-slate-200 flex justify-between items-center"><span className="text-slate-500">Total Operación</span><span className="text-3xl font-extrabold text-slate-900">{formatMoney(detailsItem.total)}</span></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>